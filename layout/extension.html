{% extends "base.html" %}

{% block title %}{{ extension_name }} - PostgreSQL Extension Analysis{% endblock %}

{% block content %}
<div class="extension-header">
    <h1>{{ extension_name }}</h1>
</div>
{% if source_code %}
<div class="source-code-line">
    <svg class="code-icon" viewBox="0 0 24 24" fill="currentColor">
        <path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0L19.2 12l-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/>
    </svg>
    <a href="{{ source_code }}" target="_blank">{{ source_code }}</a>
</div>
{% endif %}

<div class="extension-details">
    {% if include_descriptions and description %}
    <p class="description">{{ description }}</p>
    {% endif %}
    
    <div class="analysis-section">
        <h3>Information Analysis</h3>
        <div class="analysis-box">
            <table class="metrics-table">
                <tr>
                    <td><strong>Extensibility Types:</strong></td>
                    <td>
                        {% for ext_type in extensibility_types %}
                        {% if ext_type != 'None' %}
                        <a href="results.html?filter={{ ext_type|urlencode }}" class="extensibility-link">{{ ext_type }}</a>{% if not loop.last %}, {% endif %}
                        {% else %}
                        {{ ext_type }}
                        {% endif %}
                        {% endfor %}
                    </td>
                </tr>
                <tr>
                    <td><strong>System Components:</strong></td>
                    <td>{{ system_components|join(', ') }}</td>
                </tr>
            </table>
        </div>
    </div>
    
    <div class="analysis-section">
        <h3>Duplicate Code Analysis</h3>
        <div class="analysis-box">
            <table class="metrics-table">
                {% if postgres_data %}
                <tr>
                    <td><strong>Total Lines of Code:</strong> <span class="tooltip" title="Number of lines of C/C++/Rust code in an extension. Does not include SQL.">?</span></td>
                    <td>{{ postgres_data.total_loc or 'N/A' }}</td>
                </tr>
                <tr>
                    <td><strong>Lines of Duplicate Code:</strong> <span class="tooltip" title="Number of LOC an extension has copied from PostgreSQL to use in its own codebase.">?</span></td>
                    <td>{{ postgres_data.copied_postgres_loc or '0' }}</td>
                </tr>
                <tr>
                    <td><strong>Percentage of Codebase:</strong> <span class="tooltip" title="Percentage of codebase consisting of duplicate code from PostgreSQL.">?</span></td>
                    <td>{{ postgres_data.pct_copied_loc or '0' }}%</td>
                </tr>
                {% else %}
                <tr>
                    <td><strong>Total Lines of Code:</strong></td>
                    <td>No data available</td>
                </tr>
                <tr>
                    <td><strong>Lines of Duplicate Code:</strong></td>
                    <td>No data available</td>
                </tr>
                <tr>
                    <td><strong>Percentage of Codebase:</strong></td>
                    <td>No data available</td>
                </tr>
                {% endif %}
            </table>
        </div>
    </div>
    
    <div class="analysis-section">
        <h3>Versioning Analysis</h3>
        <div class="analysis-box">
            <table class="metrics-table">
                {% if versioning_data %}
                <tr>
                    <td><strong>Total Lines of Code:</strong> <span class="tooltip" title="Number of lines of C/C++/Rust code in an extension. Does not include SQL.">?</span></td>
                    <td>{{ versioning_data.total_loc or 'N/A' }}</td>
                </tr>
                <tr>
                    <td><strong>Lines of Encapsulated Versioning Code:</strong> <span class="tooltip" title="Number of LOC encapsulated by #ifdef statements with PG_VERSION_NUM (a macro with a number representing the PostgreSQL version).">?</span></td>
                    <td>{{ versioning_data.versioning_loc or '0' }}</td>
                </tr>
                <tr>
                    <td><strong>Percentage of Encapsulated Versioning Code in Codebase:</strong> <span class="tooltip" title="Percentage of codebase consisting of code inside the PG_VERSION_NUM #ifdef statements.">?</span></td>
                    <td>{{ versioning_data.pct_versioning_loc or '0' }}%</td>
                </tr>
                {% if versioning_data.versioning_loc and versioning_data.versioning_loc != '0' %}
                <tr>
                    <td><strong>PostgreSQL Versions Cased On:</strong> <span class="tooltip" title="PostgreSQL versions cased on by an extension (the PG_VERSION_NUM values). ">?</span></td>
                    <td>{{ version_list|join(',') if version_list else 'None' }}</td>
                </tr>
                {% endif %}
                {% else %}
                <tr>
                    <td><strong>Total Lines of Code:</strong></td>
                    <td>No data available</td>
                </tr>
                <tr>
                    <td><strong>Lines of Encapsulated Versioning Code:</strong></td>
                    <td>No data available</td>
                </tr>
                <tr>
                    <td><strong>Percentage of Encapsulated Versioning Code in Codebase:</strong></td>
                    <td>No data available</td>
                </tr>
                {% endif %}
            </table>
        </div>
    </div>
    
    {% if has_compatibility_data %}
    <div class="analysis-section">
        <h3>Compatibility Analysis</h3>
        <div class="analysis-box">
            <table class="metrics-table">
                <tr>
                    <td><strong>Number of Failed Extensions:</strong> </td>
                    <td>{{ failed_extensions|length }}</td>
                </tr>
                <tr>
                    <td><strong>Failure Rate:</strong></td>
                    <td>{{ "%.1f"|format(failure_rate) }}%</td>
                </tr>
            </table>
        </div>
    </div>
    
    {% if failed_extensions %}
    <div class="analysis-section">
        <h3>Failed Extensions</h3>
        <div class="analysis-box">
            {% for failed_ext, outputs in terminal_outputs %}
            <div class="failed-extension-section">
                <h4 class="failed-extension-title">{{ failed_ext }}</h4>
                {% for output in outputs %}
                <div class="terminal-dropdown">
                    <button class="dropdown-btn" onclick="toggleTerminal('terminal-{{ failed_ext|replace('_', '-') }}-{{ loop.index }}')">
                        Terminal output ({{ output.first_ext }}, {{ output.second_ext }}) ▼
                    </button>
                    <div id="terminal-{{ failed_ext|replace('_', '-') }}-{{ loop.index }}" class="terminal-output hidden">
                        <pre><code>{{ output.content }}</code></pre>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    {% endif %}
</div>

<script>
function toggleTerminal(terminalId) {
    const terminal = document.getElementById(terminalId);
    const btn = terminal.previousElementSibling;
    
    if (terminal.classList.contains('hidden')) {
        terminal.classList.remove('hidden');
        btn.innerHTML = btn.innerHTML.replace('▼', '▲');
    } else {
        terminal.classList.add('hidden');
        btn.innerHTML = btn.innerHTML.replace('▲', '▼');
    }
}
</script>
{% endblock %}