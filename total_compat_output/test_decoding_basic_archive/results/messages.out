-- predictability
SET synchronous_commit = on;
SELECT 'init' FROM pg_create_logical_replication_slot('regression_slot', 'test_decoding');
ERROR:  logical decoding requires wal_level >= logical
SELECT 'msg1' FROM pg_logical_emit_message(true, 'test', 'msg1');
 ?column? 
----------
 msg1
(1 row)

SELECT 'msg2' FROM pg_logical_emit_message(false, 'test', 'msg2');
 ?column? 
----------
 msg2
(1 row)

BEGIN;
SELECT 'msg3' FROM pg_logical_emit_message(true, 'test', 'msg3');
 ?column? 
----------
 msg3
(1 row)

SELECT 'msg4' FROM pg_logical_emit_message(false, 'test', 'msg4');
 ?column? 
----------
 msg4
(1 row)

ROLLBACK;
BEGIN;
SELECT 'msg5' FROM pg_logical_emit_message(true, 'test', 'msg5');
 ?column? 
----------
 msg5
(1 row)

SELECT 'msg6' FROM pg_logical_emit_message(false, 'test', 'msg6');
 ?column? 
----------
 msg6
(1 row)

SELECT 'msg7' FROM pg_logical_emit_message(true, 'test', 'msg7');
 ?column? 
----------
 msg7
(1 row)

COMMIT;
SELECT 'ignorethis' FROM pg_logical_emit_message(true, 'test', 'czechtastic');
  ?column?  
------------
 ignorethis
(1 row)

SELECT data FROM pg_logical_slot_get_changes('regression_slot', NULL, NULL, 'force-binary', '0', 'skip-empty-xacts', '1');
ERROR:  logical decoding requires wal_level >= logical
-- test db filtering
\set prevdb :DBNAME
\c template1
SELECT 'otherdb1' FROM pg_logical_emit_message(false, 'test', 'otherdb1');
 ?column? 
----------
 otherdb1
(1 row)

SELECT 'otherdb2' FROM pg_logical_emit_message(true, 'test', 'otherdb2');
 ?column? 
----------
 otherdb2
(1 row)

\c :prevdb
SELECT data FROM pg_logical_slot_get_changes('regression_slot', NULL, NULL, 'force-binary', '0', 'skip-empty-xacts', '1');
ERROR:  logical decoding requires wal_level >= logical
SELECT 'cleanup' FROM pg_drop_replication_slot('regression_slot');
ERROR:  replication slot "regression_slot" does not exist
